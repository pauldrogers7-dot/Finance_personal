<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FinanceVault: Bulletproof v70</title>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --accent: #3498db; }
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
        .navbar { background: var(--primary); padding: 10px; display: flex; gap: 10px; }
        .nav-btn { color: white; background: rgba(255,255,255,0.1); border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .page { display: none; padding: 20px; }
        .page.active { display: block; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .bal-grid { display: flex; gap: 10px; flex-wrap: wrap; }
        .bal-card { background: var(--accent); color: white; padding: 20px; border-radius: 8px; min-width: 150px; text-align: center; font-weight: bold; }
        input, select, button { width: 100%; padding: 12px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        .btn-go { background: var(--success); color: white; border: none; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; }
        td, th { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="navbar">
    <button class="nav-btn" onclick="goTo('pg-dash')">Dashboard</button>
    <button class="nav-btn" onclick="goTo('pg-rec')">Recurring</button>
    <button class="nav-btn" onclick="goTo('pg-cats')">Categories</button>
    <button class="nav-btn" onclick="goTo('pg-sett')">Settings</button>
</div>

<div class="container">
    <div id="pg-dash" class="page active">
        <div class="card">
            <h3>Bank Balances</h3>
            <div id="box-bal" class="bal-grid"></div>
        </div>
        <div class="card">
            <h3>Add Bank Account</h3>
            <input type="text" id="in-bank-name" placeholder="Bank Name">
            <input type="number" id="in-bank-bal" placeholder="Opening Balance £">
            <button class="btn-go" onclick="doAddBank()">Create Bank Card</button>
        </div>
    </div>

    <div id="pg-rec" class="page">
        <div class="card">
            <h3 id="rec-head">Add Recurring</h3>
            <input type="hidden" id="edit-rec-id" value="">
            <input type="text" id="in-rec-desc" placeholder="Netflix/Rent">
            <input type="number" id="in-rec-amt" placeholder="£">
            <select id="sel-rec-bank"></select>
            <select id="sel-rec-cat"></select>
            <input type="date" id="in-rec-date">
            <button class="btn-go" onclick="doSaveRec()">Save Recurring</button>
        </div>
        <div class="card">
            <table id="tbl-rec"><thead><tr><th>Name</th><th>£</th><th>Action</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <div id="pg-cats" class="page">
        <div class="card">
            <h3 id="cat-head">Category Manager</h3>
            <input type="hidden" id="edit-cat-id" value="">
            <input type="text" id="in-cat-name" placeholder="Category Name">
            <select id="in-cat-type"><option value="exp">Expense</option><option value="inc">Income</option></select>
            <button class="btn-go" onclick="doSaveCat()">Save Category</button>
        </div>
        <div class="card">
            <table id="tbl-cat"><thead><tr><th>Name</th><th>Type</th><th>Action</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <div id="pg-sett" class="page">
        <div class="card">
            <h3>Security</h3>
            <input type="password" id="in-pin" placeholder="Enter New PIN">
            <button class="btn-go" onclick="doSavePin()">Update PIN</button>
        </div>
        <button onclick="localStorage.clear(); location.reload();" style="background:red; color:white; border:none; padding:15px; cursor:pointer;">DEBUG: FULL RESET</button>
    </div>
</div>

<script>
    const STORAGE_KEY = 'FINANCE_VAULT_V70';
    
    // Initialize Data
    let vault = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
        banks: [],
        cats: [{id: 1, name: "Salary", type: "inc"}, {id: 2, name: "Rent", type: "exp"}],
        recs: [],
        txs: [],
        pin: "1234"
    };

    function sync() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(vault));
        draw();
    }

    // TAB NAVIGATION
    function goTo(pageId) {
        let pages = document.getElementsByClassName('page');
        for (let i = 0; i < pages.length; i++) {
            pages[i].style.display = 'none';
        }
        document.getElementById(pageId).style.display = 'block';
        draw();
    }

    // ACTIONS
    function doAddBank() {
        let n = document.getElementById('in-bank-name').value;
        let b = parseFloat(document.getElementById('in-bank-bal').value);
        if(n && !isNaN(b)) {
            vault.banks.push({name: n, initial: b});
            document.getElementById('in-bank-name').value = "";
            document.getElementById('in-bank-bal').value = "";
            sync();
        }
    }

    function doSaveCat() {
        let n = document.getElementById('in-cat-name').value;
        let t = document.getElementById('in-cat-type').value;
        let eid = document.getElementById('edit-cat-id').value;
        if(n) {
            if(eid) {
                let c = vault.cats.find(x => x.id == eid);
                if(c) { c.name = n; c.type = t; }
            } else {
                vault.cats.push({id: Date.now(), name: n, type: t});
            }
            document.getElementById('in-cat-name').value = "";
            document.getElementById('edit-cat-id').value = "";
            sync();
        }
    }

    function doSaveRec() {
        let d = document.getElementById('in-rec-desc').value;
        let a = parseFloat(document.getElementById('in-rec-amt').value);
        let eid = document.getElementById('edit-rec-id').value;
        if(d && !isNaN(a)) {
            if(eid) {
                let r = vault.recs.find(x => x.id == eid);
                if(r) { r.desc = d; r.amt = a; }
            } else {
                vault.recs.push({id: Date.now(), desc: d, amt: a});
            }
            document.getElementById('in-rec-desc').value = "";
            document.getElementById('in-rec-amt').value = "";
            document.getElementById('edit-rec-id').value = "";
            sync();
        }
    }

    function doSavePin() {
        vault.pin = document.getElementById('in-pin').value;
        sync();
        alert("PIN Managed Successfully via Settings!");
    }

    // EDIT TRIGGERS
    function triggerEditCat(id) {
        let c = vault.cats.find(x => x.id == id);
        document.getElementById('in-cat-name').value = c.name;
        document.getElementById('in-cat-type').value = c.type;
        document.getElementById('edit-cat-id').value = c.id;
    }

    function triggerEditRec(id) {
        let r = vault.recs.find(x => x.id == id);
        document.getElementById('in-rec-desc').value = r.desc;
        document.getElementById('in-rec-amt').value = r.amt;
        document.getElementById('edit-rec-id').value = r.id;
    }

    // DRAW ENGINE (The "Bulletproof" part)
    function draw() {
        // Draw Banks
        try {
            let bBox = document.getElementById('box-bal');
            bBox.innerHTML = "";
            vault.banks.forEach(b => {
                bBox.innerHTML += `<div class="bal-card">${b.name}<br>£${b.initial.toFixed(2)}</div>`;
            });
        } catch(e) { console.log("Bank Render Error"); }

        // Draw Category Table
        try {
            let cTbl = document.querySelector('#tbl-cat tbody');
            cTbl.innerHTML = vault.cats.map(c => `
                <tr><td>${c.name}</td><td>${c.type}</td>
                <td><button onclick="triggerEditCat(${c.id})">Edit</button></td></tr>
            `).join('');
        } catch(e) { console.log("Cat Render Error"); }

        // Draw Recurring Table
        try {
            let rTbl = document.querySelector('#tbl-rec tbody');
            rTbl.innerHTML = vault.recs.map(r => `
                <tr><td>${r.desc}</td><td>£${r.amt}</td>
                <td><button onclick="triggerEditRec(${r.id})">Edit</button></td></tr>
            `).join('');
        } catch(e) { console.log("Rec Render Error"); }
    }

    window.onload = draw;
</script>
</body>
</html>
