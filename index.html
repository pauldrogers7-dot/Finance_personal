<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Pro: Zero-Error Version</title>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --danger: #e74c3c; --accent: #3498db; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #333; }
        
        /* Nav */
        nav { background: var(--primary); color: white; padding: 0 20px; display: flex; align-items: center; height: 60px; gap: 30px; }
        .nav-btn { cursor: pointer; padding: 20px 10px; font-weight: bold; border-bottom: 3px solid transparent; opacity: 0.7; }
        .nav-btn:hover { opacity: 1; }
        .nav-btn.active { border-bottom: 3px solid var(--accent); opacity: 1; }

        /* Container & Grid */
        .container { padding: 25px; max-width: 1200px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        
        /* Visibility */
        .page-content { display: none; }
        .page-content.active { display: block; }

        /* Balance Cards */
        .bal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 10px; }
        .bal-card { background: var(--accent); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .bal-card strong { font-size: 1.5em; display: block; margin-top: 5px; }

        /* Form styling */
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
        button { cursor: pointer; border: none; font-weight: bold; }
        .btn-go { background: var(--success); color: white; }
        .btn-reset { background: var(--danger); color: white; margin-top: 20px; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<nav>
    <div style="font-size: 1.4em; font-weight: bold; color: var(--accent); margin-right: 20px;">FinanceVault</div>
    <div class="nav-btn active" id="tab-dash" onclick="switchPage('dash')">Dashboard</div>
    <div class="nav-btn" id="tab-cats" onclick="switchPage('cats')">Manage Categories</div>
</nav>

<div class="container">
    
    <div id="view-dash" class="page-content active">
        <div class="card">
            <h2>Account Balances</h2>
            <div id="render-balances" class="bal-grid"></div>
        </div>

        <div class="grid">
            <div>
                <div class="card">
                    <h3>One-Off Transaction</h3>
                    <form onsubmit="postTx(event)">
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="tx-desc" placeholder="Description" required>
                            <input type="number" id="tx-amt" placeholder="Amount £" step="0.01" required>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <select id="sel-acc"></select>
                            <select id="sel-cat"></select>
                            <input type="date" id="tx-date" required>
                        </div>
                        <button class="btn-go">Post to Account</button>
                    </form>
                </div>

                <div class="card">
                    <h3>Recent History</h3>
                    <table id="tx-table">
                        <thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Acc</th><th></th></tr></thead>
                        <tbody id="render-history"></tbody>
                    </table>
                </div>
            </div>

            <div>
                <div class="card">
                    <h3>Setup Bank Account</h3>
                    <form onsubmit="postAcc(event)">
                        <input type="text" id="acc-name" placeholder="Bank Name" required>
                        <input type="number" id="acc-init" placeholder="Opening Balance £" step="0.01" required>
                        <button style="background:var(--primary); color:white;">Add Account</button>
                    </form>
                </div>
                <button onclick="nuclearReset()" class="btn-reset">Wipe App Data</button>
            </div>
        </div>
    </div>

    <div id="view-cats" class="page-content">
        <div class="card">
            <h2>Category Table Editor</h2>
            <table>
                <thead><tr><th>Category Name</th><th>Type</th><th>Action</th></tr></thead>
                <tbody id="render-cat-table"></tbody>
            </table>

            <h3 style="margin-top:30px;">Add New Category</h3>
            <form onsubmit="postCat(event)" style="display:flex; gap:10px;">
                <input type="text" id="new-cat-name" placeholder="Name" required>
                <select id="new-cat-type" style="width:200px;">
                    <option value="exp">Expense (-)</option>
                    <option value="inc">Income (+)</option>
                </select>
                <button class="btn-go" style="width:150px;">Add Category</button>
            </form>
        </div>
    </div>

</div>

<script>
    // 1. DATA INITIALIZATION
    const KEY = 'FINANCE_SYSTEM_2026';
    let data = JSON.parse(localStorage.getItem(KEY)) || {
        accounts: {},
        txs: [],
        categories: [
            { name: "Salary", type: "inc" },
            { name: "Rent", type: "exp" },
            { name: "Groceries", type: "exp" }
        ]
    };

    // 2. REFRESH & SAVE ENGINE
    function sync() {
        localStorage.setItem(KEY, JSON.stringify(data));
        renderBalances();
        renderHistory();
        renderCats();
        updateDropdowns();
    }

    // 3. PAGE SWITCHER (FIXED)
    function switchPage(target) {
        // Hide all views
        document.getElementById('view-dash').classList.remove('active');
        document.getElementById('view-cats').classList.remove('active');
        // Deactivate tabs
        document.getElementById('tab-dash').classList.remove('active');
        document.getElementById('tab-cats').classList.remove('active');

        // Show active
        document.getElementById('view-' + target).classList.add('active');
        document.getElementById('tab-' + target).classList.add('active');
        
        console.log("Navigated to: " + target);
    }

    // 4. ACTION FUNCTIONS
    function postAcc(e) {
        e.preventDefault();
        const name = document.getElementById('acc-name').value;
        const val = parseFloat(document.getElementById('acc-init').value);
        data.accounts[name] = val;
        sync();
        e.target.reset();
    }

    function postCat(e) {
        e.preventDefault();
        data.categories.push({
            name: document.getElementById('new-cat-name').value,
            type: document.getElementById('new-cat-type').value
        });
        sync();
        e.target.reset();
    }

    function postTx(e) {
        e.preventDefault();
        const catName = document.getElementById('sel-cat').value;
        const catData = data.categories.find(c => c.name === catName);
        
        data.txs.push({
            id: Date.now(),
            desc: document.getElementById('tx-desc').value,
            amt: parseFloat(document.getElementById('tx-amt').value),
            date: document.getElementById('tx-date').value,
            acc: document.getElementById('sel-acc').value,
            type: catData ? catData.type : 'exp'
        });
        sync();
        e.target.reset();
        document.getElementById('tx-date').valueAsDate = new Date();
    }

    // 5. RENDERING (THE STABILITY FIX)
    function renderBalances() {
        const area = document.getElementById('render-balances');
        const names = Object.keys(data.accounts);
        
        if (names.length === 0) {
            area.innerHTML = '<p style="color:#666; padding:20px;">No accounts yet. Use the sidebar to add your first bank.</p>';
            return;
        }

        area.innerHTML = '';
        names.forEach(name => {
            const start = data.accounts[name] || 0;
            const history = data.txs.filter(t => t.acc === name);
            const net = history.reduce((acc, t) => acc + (t.type === 'inc' ? t.amt : -t.amt), 0);
            
            area.innerHTML += `
                <div class="bal-card">
                    ${name}
                    <strong>£${(start + net).toFixed(2)}</strong>
                </div>`;
        });
    }

    function renderHistory() {
        const body = document.getElementById('render-history');
        body.innerHTML = data.txs.slice().reverse().slice(0,10).map(t => `
            <tr>
                <td>${t.date}</td>
                <td>${t.desc}</td>
                <td style="color:${t.type==='inc'?'green':'red'}">£${t.amt.toFixed(2)}</td>
                <td>${t.acc}</td>
                <td><button onclick="deleteTx(${t.id})" style="color:red; background:none; width:auto;">&times;</button></td>
            </tr>
        `).join('');
    }

    function renderCats() {
        const body = document.getElementById('render-cat-table');
        body.innerHTML = data.categories.map((c, i) => `
            <tr>
                <td><strong>${c.name}</strong></td>
                <td>${c.type === 'inc' ? 'Income' : 'Expense'}</td>
                <td><button onclick="data.categories.splice(${i},1); sync();" style="color:red; background:none; width:auto;">Delete</button></td>
            </tr>
        `).join('');
    }

    function updateDropdowns() {
        const accs = Object.keys(data.accounts);
        document.getElementById('sel-acc').innerHTML = accs.map(a => `<option>${a}</option>`).join('');
        document.getElementById('sel-cat').innerHTML = data.categories.map(c => `<option>${c.name}</option>`).join('');
    }

    function deleteTx(id) {
        data.txs = data.txs.filter(t => t.id !== id);
        sync();
    }

    function nuclearReset() {
        if(confirm("Wipe everything?")) {
            localStorage.clear();
            location.reload();
        }
    }

    // BOOT UP
    window.onload = () => {
        document.getElementById('tx-date').valueAsDate = new Date();
        sync();
        console.log("App Booted Successfully");
    };
</script>
</body>
</html>
